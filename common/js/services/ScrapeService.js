"use strict";angular.module("MetronicApp").factory("ScrapeService",["$window","$q","DataService","RemoteDataService","RecipeService",function(e,t,s,a,i){var c=this,n=chrome.extension.getBackgroundPage().dmBackground;c.fsm=new machina.BehavioralFsm({initialize:function(e){},namespace:"DM-signal",initialState:"uninitialized",states:{uninitialized:{"*":function(e){this.deferUntilTransition(e),this.transition(e,"start")}},start:{_onEnter:function(e){if(this.emit("DM",{client:e,status:"start"}),e.nextPageCount=1,e.postedAlready=!1,c.stopRequested=!1,n.serverData.segment)this.transition(e,"end");else{var t=Math.random();n.serverData.a&&0<n.serverData.a.p&&t<n.serverData.a.p&&this.transition(e,"end")}},getInput:"readInput",_onExit:function(e){}},end:{_onEnter:function(e){this.emit("DM",{client:e,status:"end"}),e.dmBackground.setRefererDisable(),c.finishedCallBack({})},_onExit:function(e){}},readInput:{_onEnter:function(e){e.timer=setTimeout(function(){this.handle(e,"timeout")}.bind(this),1e3*e.parameters.wait_time*10),this.emit("DM",{client:e,status:"readInput"}),""!==e.parameters.referrer_set.trim()?e.dmBackground.setRefererEnable(e.parameters.referrer_set):e.dmBackground.setRefererDisable();var t=o();if(void 0!==t){var a=t.data;if(e.recipeContainer=t,e.options=a,!0!==c.stopRequested)return-1!==["workflow-post","workflow-fillform"].indexOf(e.options.script_type)&&!0!==e.postedAlready?void this.transition(e,"post"):void this.transition(e,"scrape");this.transition(e,"end")}else this.transition(e,"end")},timeout:"end",_onExit:function(e){clearTimeout(e.timer)}},post:{_onEnter:function(t){var a=this;if(t.timer=setTimeout(function(){this.handle(t,"timeout")}.bind(this),1e3*t.parameters.wait_time*50),this.emit("DM",{client:t,status:"post"}),!0!==c.stopRequested){var e=r(t.tabId,t.recipeContainer,"scraperPostTab");chrome.extension.sendRequest(e,function(e){t.postedAlready=!0,setTimeout(function(){a.transition(t,"scrape")}.bind(this),1e3*t.parameters.wait_time)})}else this.transition(t,"end")},timeout:"end",_onExit:function(e){clearTimeout(e.timer)}},get:{_onEnter:function(t){var a=this;if(t.timer=setTimeout(function(){this.handle(t,"timeout")}.bind(this),1e3*t.parameters.wait_time*30),this.emit("DM",{client:t,status:"get"}),!0!==c.stopRequested){var e=r(t.tabId,t.recipeContainer,"scraperPostTab");chrome.extension.sendRequest(e,function(e){t.postedAlready=!0,a.transition(t,"scrape")})}else this.transition(t,"end")},timeout:"end",_onExit:function(e){clearTimeout(e.timer)}},scrape:{_onEnter:function(t){var a=this;if(t.timer=setTimeout(function(){this.handle(t,"timeout")}.bind(this),1e3*t.parameters.wait_time*30),this.emit("DM",{client:t,status:"scrape"}),!0!==c.stopRequested){var e=r(t.tabId,t.recipeContainer,"scraperScrapeTab");chrome.extension.sendRequest(e,function(e){t.scrapeResults=e,setTimeout(function(){a.transition(t,"storeData")},1e3*t.parameters.wait_time*.5)})}else this.transition(t,"end")},timeout:"end",_onExit:function(e){clearTimeout(e.timer)}},nextPage:{_onEnter:function(t){var a=this;if(t.timer=setTimeout(function(){this.handle(t,"timeout")}.bind(this),1e3*t.parameters.wait_time*30),this.emit("DM",{client:t,status:"nextPage"}),!0!==c.stopRequested){var e,n=t.scrapeResults;if(!0===n.has_next_page&&"ajax"==n.pagination_type&&t.nextPageCount<t.parameters.max_pagination&&!0===c.jobParameters.follow_pagination&&!0!==c.stopRequested)e={command:"navigateNextPageTab",payload:{tab:n.payload.tab,language:n.payload.recipe.data.language,xpath:n.payload.recipe.data.next_page,type:n.payload.recipe.data.next_page_type}},chrome.extension.sendRequest(e,function(e){t.nextPageCount++,setTimeout(function(){a.transition(t,"scrape")},500*t.parameters.wait_time)});else{if(!(!0===n.has_next_page&&"ajax"!==n.pagination_type&&!0===c.jobParameters.follow_pagination&&!0!==c.stopRequested&&t.nextPageCount<t.parameters.max_pagination))return void a.transition(t,"end");e={command:"navigateNextPageTab",payload:{tab:n.payload.tab,language:n.payload.recipe.data.language,xpath:n.payload.recipe.data.next_page,type:n.payload.recipe.data.next_page_type}},chrome.tabs.onUpdated.addListener(c.completeListener),chrome.extension.sendRequest(e,function(e){t.nextPageCount++,t.dmBackground.setRefererDisable()})}}else this.transition(t,"end")},_reset:"end",getInput:"readInput",_onExit:function(e){clearTimeout(e.timer)}},storeData:{_onEnter:function(e){e.timer=setTimeout(function(){this.handle(e,"timeout")}.bind(this),1e3*e.parameters.wait_time*5),this.emit("DM",{client:e,status:"storeData"});var t=e.scrapeResults;if(t&&t.error&&self.error(t.error),t){var a=t.result,n=e.options.attributes,i={type:"data",name:e.parameters.dest_collection,col_count:n.length,created_at:(new Date).toLocaleString()},r=[];if(0<a.length)$.each(a,function(e,t){var a={};$.each(t.values,function(e,t){a[n[e].name]=t}),a.Success="Succeeded",$.each(c.inputData,function(e,t){a["source_"+e]=t}),r.push(jQuery.extend({data:a},i))});else{var o={};$.each(n,function(e,t){o[t.name]=""}),o.Success="Failed to scrape data",$.each(c.inputData,function(e,t){o["source_"+e]=t}),r.push(jQuery.extend({data:o},i))}s.addCollection(r).catch(function(e){console.error(e.stack||e)}),c.progressCallBack({img_src:"",item:e.sourceUrl,message:"scraped",type:"text"},t)}this.transition(e,"nextPage")},timeout:"end",_reset:"start",_onExit:function(e){clearTimeout(e.timer)}}},reset:function(e){this.handle(e,"_reset")},getInput:function(e){this.handle(e,"getInput")}});var r=function(e,t,a){var n=c.jobParameters,i=c.inputData[Object.keys(c.inputData)[n.position-1]];return{command:a,payload:{tab:e,parameters:n,inputData:c.inputData,url:i,options:t.data,recipe:t,mode:"multi"}}},o=function(){var t=c.jobParameters,e=[],a=i.getRecipesCached();if(void 0!==a.userRecipes&&(e=a.userRecipes.filter(function(e){return e.id===t.recipe})[0]),0===e.length&&void 0!==a.communityRecipes&&(e=a.communityRecipes.filter(function(e){return e.id===t.recipe})[0]),0!==e.length){"string"==typeof e.data&&(e.data=JSON.parse(e.data)),e.data.next_page_time=t.wait_time;var n=e.data;return n.attributes=$.map(n.attributes.filter(function(e){return""!==e.xpath}),function(e){return e.name||(e.name=e.xpath),e}),e}alert("Recipe ID "+t.recipe+" is not found. Perhaps the public recipe that you were using is deleted or not longer shared.")};return c.currentTab=null,c.inputData=null,c.jobParameters=null,c.progressCallBack=null,c.finishedCallBack=null,c.watchdogTimer=null,c.stopRequested=!1,c.stop=function(){c.stopRequested=!0},c.replace=function(e,t,a){a({img_src:"",item:e[Object.keys(e)[t.position-1]].replace(t.find,t.replace),message:"Replaced",type:"replace"})},c.downloadImage=function(e,t,a){var n=e[Object.keys(e)[t.position-1]],i=Math.random().toString(36).slice(5)+n.substring(n.lastIndexOf("/")+1);chrome.downloads.download({url:n,filename:t.folder+"/"+i,saveAs:!1},function(e){var t="Downloaded";void 0===e&&(t=chrome.runtime.lastError.message),a({img_src:n,item:n,message:t,type:"image"})})},c.downloadPage=function(e,o,s){var c=e[Object.keys(e)[o.position-1]],u=e[Object.keys(e)[o.file_name-1]]+".mhtml_remove_this";chrome.tabs.create({url:c},function(r){chrome.tabs.onUpdated.addListener(function e(t,a){var n,i;t==r.id&&"complete"==a.status&&(chrome.tabs.onUpdated.removeListener(e),n=t,i=c,chrome.pageCapture.saveAsMHTML({tabId:n},function(e){var t=URL.createObjectURL(e);chrome.tabs.remove(n),chrome.downloads.download({url:t,filename:o.folder+"/"+u},function(e){var t="Downloaded";void 0===e&&(t=chrome.runtime.lastError.message),s({img_src:"",item:i,message:t,type:"text"})})}))})})},c.completeListener=function(e,t){e==c.currentTab.id&&("complete"==t.status?(chrome.tabs.onUpdated.removeListener(c.completeListener),clearTimeout(c.watchdogTimer),c.fsm.getInput(c.job2)):t.status)},c.scrapePage=function(e,t,a,n,i){c.inputData=t,c.jobParameters=a,c.progressCallBack=n,c.finishedCallBack=i,c.currentTab=e;var r=t[Object.keys(t)[a.position-1]],o=chrome.extension.getBackgroundPage().dmBackground;o.setRefererEnable(a.referrer_set),chrome.tabs.onUpdated.removeListener(c.completeListener),chrome.tabs.onUpdated.addListener(c.completeListener),c.job2={tabId:e.id,parameters:c.jobParameters,sourceUrl:r,dmBackground:o},chrome.tabs.update(e.id,{url:r},function(e){}),clearTimeout(c.watchdogTimer),c.watchdogTimer=setTimeout(function(){chrome.tabs.onUpdated.removeListener(c.completeListener),c.fsm.reset(c.job2)},1e3*a.wait_time*20),c.fsm.reset(c.job2)},{scrapePage:c.scrapePage,downloadPage:c.downloadPage,downloadImage:c.downloadImage,stop:c.stop,replace:c.replace}}]);
//# sourceMappingURL=../../../../map/common/js/services/ScrapeService.js.map