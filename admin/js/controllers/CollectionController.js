"use strict";angular.module("MetronicApp").controller("CollectionListController",["$scope","$location","DataService","CurrentCollectionService","$q","$window",function(e,n,o,a,l,s){var c=this;c.collections=[],c.collectionNames=[],c.message="",c.gridHeight=s.innerHeight-250;var t=function(){var t=l.defer();return DM.testMode?t.resolve():chrome.permissions.request({permissions:["downloads"]},function(e){e?t.resolve():(alert("DataMiner needs your permission to download the file"),t.reject("Something went wrong!!!"))}),t.promise};c.getShortNames=function(){c.collectionNames=[],angular.forEach(c.collections,function(e){var t=e;e.startsWith("www.")&&(e=e.substring(4)),this.push({fullName:t,shortName:function(e,t,n){if(e.length<=t)return e;var o=t-(n=n||"...").length,a=Math.ceil(o/2),l=Math.floor(o/2);return e.substr(0,a)+n+e.substr(e.length-l)}(e,35)})},c.collectionNames)},c.downloadCSV=function(r,e){c.message="Preparing file .... please wait",t().then(function(){o.getCollectionData(r).then(function(e){var t,n=[];if($.each(e,function(e,t){n.push(t.data)}),e=null,1e4<n.length){alert("Your collection is very large. It will be downloaded in 10000 row increments.");for(var o=0;o<n.length;o+=1e4){var a=Papa.unparse(n.slice(o,1e4+o));t=r.replace(/[^\w]/g,"_")+"_"+o.toString()+".csv",console.log("Total csv length: "+n.length),console.log("File name: "+t);var l=new File([a],t,{type:"text/csv;charset=utf-8"});saveAs(l,t),c.message=""}}else{var i=Papa.unparse(n);t=r.replace(/[^\w]/g,"_")+".csv",l=new File([i],t,{type:"text/csv;charset=utf-8"}),saveAs(l,t),c.message=""}},function(e){c.message="Error",s.alert(e)})})},c.downloadXLSX=function(a,e){c.message="Preparing file .... please wait",t().then(function(){o.getCollectionData(a).then(function(e){var n='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body><tbody><table><thead><tr>';angular.forEach(e[0].data,function(e,t){n+="<th>"+t+"</th>"}),n+="</tr></thead><tbody>",angular.forEach(e,function(e){n+="<tr>",angular.forEach(e.data,function(e,t){n+="<td>"+e+"</td>"}),n+="</tr>"}),n+="</tbody></table></body></html>";var t=a.replace(/[^\w]/g,"_")+".xls",o=new File([n],t,{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8"});saveAs(o,t),c.message=""},function(e){c.message="Error",s.alert(e)})})},c.ShowProperties=function(e){console.log("Show properties")},c.refreshList=function(){o.getCollectionNames().then(function(e){c.collections=e,c.getShortNames()},function(e){s.alert(e)})},c.getNames=function(){o.getCollectionNames().then(function(e){c.collections=e},function(e){s.alert(e)})},c.select=function(t){o.getCollectionData(t).then(function(e){a.name=t,a.data=e},function(e){s.alert(e)})},c.deleteAll=function(){o.deleteCollectionAll().then(function(){c.refreshList()},function(e){s.alert(e)})},c.delete=function(e){o.deleteCollection(e).then(function(){a.name="",a.data=[],c.refreshList()},function(e){s.alert(e)})};var i=function(i,e,t){Papa.parse(i,{header:!0,skipEmptyLines:!0,dynamicTyping:!1,complete:function(l){var e=[];angular.forEach(l.data,function(e,t){for(var n={type:"data",name:i.name,created_at:(new Date).toLocaleString(),data:{}},o=e[l.meta.fields[0]],a=1;a<l.meta.fields.length;a++)o=o.split(l.meta.fields[a]).join(e[l.meta.fields[a]]);e[l.meta.fields[0]]=o,n.data=e,n.col_count=Object.keys(e).length,this.push(n)},e),o.addCollection(e).then(function(){c.refreshList(),c.message="Your data was loaded",n.path("/collections"),t()},function(e){s.alert(e)})}})};$("#csv-file").change(function(e){c.message="Loading ... please wait.";var t=e.target.files[0];i(t,0,function(){$("#csv-file").val(null)})}),$("#collection-from-template").change(function(e){c.message="Loading ... please wait.";var t=e.target.files[0];i(t,0,function(){$("#collection-from-template").val(null)})}),angular.element(s).bind("resize",function(){c.gridHeight=s.innerHeight-250,e.$digest()}),c.refreshList()}]);
//# sourceMappingURL=../../../../map/admin/js/controllers/CollectionController.js.map